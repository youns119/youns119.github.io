<!-- Related posts by category/tag overlap.
- 카테고리 겹치면 +2점
- 태그 겹치면 +1점
점수 높은 순으로 정렬해서 위에서부터 최대 10개까지 출력

정확도 손실 없음:
- site.posts 전체를 모두 후보로 평가
- 점수 규칙 동일

성능 개선:
- 후보 전체를 다 모아놓고 마지막에 sort하지 않고,
  Top-10만 유지하도록 매번 잘라서 관리
- url 대신 id 사용(안정성 개선)
-->

{% if page.id and page.related and site.posts %}
  {% assign scored = "" | split: "" %}

  {% assign page_cats = page.categories | default: "" %}
  {% assign page_tags = page.tags | default: "" %}

  {% for candidate in site.posts %}
    {% if candidate.id != page.id %}
      {% assign score = 0 %}

      <!-- 카테고리 일치 점수 -->
      {% if page_cats != "" and candidate.categories %}
        {% for cat in candidate.categories %}
          {% if page_cats contains cat %}
            {% assign score = score | plus: 2 %}
          {% endif %}
        {% endfor %}
      {% endif %}

      <!-- 태그 일치 점수 -->
      {% if page_tags != "" and candidate.tags %}
        {% for tag in candidate.tags %}
          {% if page_tags contains tag %}
            {% assign score = score | plus: 1 %}
          {% endif %}
        {% endfor %}
      {% endif %}

      {% if score > 0 %}
        {%- assign score_str = score | prepend: "000" | slice: -3, 3 -%}
        {%- capture packed -%}{{ score_str }}|||{{ candidate.id }}{%- endcapture -%}

        <!-- 후보 추가 후 Top-10만 유지 -->
        {% assign scored = scored | push: packed %}
        {% assign scored = scored | sort | reverse | slice: 0, 10 %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if scored.size > 0 %}
    <div class="page__related">
      <h4 class="page__related-title">
        {{ site.data.ui-text[site.locale].you_may_also_enjoy | default: "Related Posts" }}
      </h4>

      {% for item in scored %}
        {% assign parts = item | split: "|||" %}
        {% assign id = parts[1] %}
        {% assign post = site.posts | where: "id", id | first %}

        {% if post %}
          <!-- archive-single-custom.html은 루프 변수 post를 기대 -->
          {% include archive-single-custom.html %}
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
{% endif %}