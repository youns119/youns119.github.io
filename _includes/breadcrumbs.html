{% assign sep = site.data.ui-text[site.locale].breadcrumb_separator | default: "/" %}
{% assign home_label = site.data.ui-text[site.locale].breadcrumb_home_label | default: "Home" %}
{% assign page_crumb_title = page.breadcrumb | default: page.title %}

<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">

    <!-- Home 항상 첫 번째 -->
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a href="{{ '/' | relative_url }}" itemprop="item">
        <span itemprop="name">{{ home_label }}</span>
      </a>
      <meta itemprop="position" content="1" />
    </li>

    <!-- 카테고리 인덱스(/categories/) 페이지: Home / Categories
    category-archive.md 에
      title: "Category"
      breadcrumb: "Categories"
      permalink: /categories/
    이런 식으로 되어 있다고 가정 -->
    {% if page.url == site.category_archive.path %}
      <span class="sep">{{ sep }}</span>
      <li class="current"{% if page.locale %} lang="{{ page.locale }}"{% endif %}>
        {{ page_crumb_title }}
      </li>

    <!-- 카테고리 상세 페이지(/categories/cpp/, /categories/csharp/ 등):
      Home / Categories / C++
    (카테고리 페이지 front matter 에 breadcrumb: "C++" 같이 넣어두면 그걸 씀) -->
    {% elsif page.layout == "archive" and page.url != site.category_archive.path and page.url contains site.category_archive.path %}
      <span class="sep">{{ sep }}</span>
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a href="{{ site.category_archive.path | relative_url }}" itemprop="item">
          <span itemprop="name">Categories</span>
        </a>
        <meta itemprop="position" content="2" />
      </li>

      <span class="sep">{{ sep }}</span>
      <li class="current"{% if page.locale %} lang="{{ page.locale }}"{% endif %}>
        {{ page_crumb_title }}
      </li>

    <!-- 포스트(글) 페이지:
      Home / Categories / [카테고리 breadcrumb or title] / [글 breadcrumb or title] -->
    {% elsif page.collection == "posts" and page.categories[0] %}
      {%- assign cat_base = site.category_archive.path | default: "/categories/" -%}
      {%- assign cat_slug = page.categories[0] | slugify -%}

      <!-- 카테고리 페이지 찾기: /categories/slug/ 또는 /categories/slug -->
      {%- assign cat_permalink1 = cat_base | append: cat_slug | append: "/" -%}
      {%- assign cat_permalink2 = cat_base | append: cat_slug -%}
      {%- assign cat_page = site.pages | where: "permalink", cat_permalink1 | first -%}
      {%- if cat_page == nil -%}
        {%- assign cat_page = site.pages | where: "permalink", cat_permalink2 | first -%}
      {%- endif -%}

      {%- if cat_page -%}
        {%- assign cat_label = cat_page.breadcrumb | default: cat_page.title | default: page.categories[0] -%}
        {%- assign cat_url   = cat_page.url -%}
      {%- else -%}
        {%- assign cat_label = page.categories[0] -%}
        {%- assign cat_url   = cat_permalink1 -%}
      {%- endif -%}

      <!-- Categories 인덱스 -->
      <span class="sep">{{ sep }}</span>
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a href="{{ cat_base | relative_url }}" itemprop="item">
          <span itemprop="name">Categories</span>
        </a>
        <meta itemprop="position" content="2" />
      </li>

      <!-- 카테고리 페이지 (여기가 C#, C++ 등) -->
      <span class="sep">{{ sep }}</span>
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a href="{{ cat_url | relative_url }}" itemprop="item">
          <span itemprop="name">{{ cat_label }}</span>
        </a>
        <meta itemprop="position" content="3" />
      </li>

      <!-- 현재 글 제목 -->
      <span class="sep">{{ sep }}</span>
      <li class="current"{% if page.locale %} lang="{{ page.locale }}"{% endif %}>
        {{ page_crumb_title }}
      </li>

    <!-- 그 외 일반 페이지(about, search 등)는 예전 방식 비슷하게 URL 조각 기준 -->
    {% else %}
      {% assign crumbs = page.url | split: "/" %}
      {% assign i = 1 %}
      {% for crumb in crumbs offset: 1 %}
        {% if forloop.first %}
          <!-- 이미 Home 은 위에서 찍었으니까 여기선 sep 만 추가 -->
          <span class="sep">{{ sep }}</span>
        {% endif %}

        {% if forloop.last %}
          <li class="current"{% if page.locale %} lang="{{ page.locale }}"{% endif %}>
            {{ page_crumb_title }}
          </li>
        {% else %}
          {% assign i = i | plus: 1 %}
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="{{ crumb | downcase
                         | replace: '%20', '-'
                         | prepend: '/'
                         | relative_url }}"
               itemprop="item">
              <span itemprop="name">
                {{ crumb | url_decode | replace: '-', ' ' | capitalize }}
              </span>
            </a>
            <meta itemprop="position" content="{{ i }}" />
          </li>
          <span class="sep">{{ sep }}</span>
        {% endif %}
      {% endfor %}
    {% endif %}

  </ol>
</nav>
